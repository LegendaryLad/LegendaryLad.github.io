<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Ledger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js"></script>
    <script type="text/javascript">WebFont.load({  google: {    families: ["Bitter:400,700,400italic","Geologica:regular","Space Grotesk:regular","Jost:regular,italic","Ysabeau:regular,italic","Urbanist:regular,italic"]  }});</script>
    <style>
        body {
            font-family: "Space Grotesk", "Urbanist", sans-serif;
            background-color: #ffffff;
            color: #000000;
        }
        .ledger-entry {
            border-bottom: 1px solid #cccccc;
            padding-top: 12px;
            padding-bottom: 12px;
        }
        .ledger-entry:last-child {
            border-bottom: none;
        }
        .entry-id {
            font-weight: bold;
            margin-right: 8px;
            flex-shrink: 0;
        }
        .entry-title {
            font-weight: bold;
        }
        .entry-title.clickable {
            cursor: pointer;
            color: #1d4ed8; /* blue-700 */
        }
        .entry-description {
            margin-top: 4px;
            font-size: 0.9em;
            color: #333333; /* Slightly lighter black for description for contrast */
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .highlight {
            background-color: #d1d5db; /* Light gray for highlighting search matches */
            font-weight: bold;
        }
        /* Ensure input text is black on white */
        input[type="text"] {
            color: #000000;
            background-color: #ffffff;
            border: 1px solid #000000;
        }

        /* Modal styles */
        #submissionModal {
            background-color: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body class="bg-white text-black min-h-screen p-4 md:p-8">
    <div class="container mx-auto max-w-3xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold">The Ledger</h1>
        </header>

        <div class="mb-6">
            <input type="text" id="searchInput" placeholder="Seek your name or number..." class="w-full p-3 border border-black rounded-md shadow-sm focus:ring-black focus:border-black text-black bg-white">
        </div>


        <div id="ledgerEntries" class="bg-white p-0 md:p-6 rounded-md">
            <!-- Entries will be dynamically inserted here -->
        </div>

        <!-- Modal for submissions -->
        <div id="submissionModal" class="hidden fixed inset-0 items-center justify-center">
            <div class="bg-white p-6 rounded-md w-11/12 md:w-2/3 lg:w-1/2">
                <h2 id="modalTitle" class="text-xl font-bold mb-2"></h2>
                <p class="mb-2">connect the cubes...</p>
                <textarea id="storyInput" class="w-full border border-black p-2 mb-4 text-black bg-white" rows="4" placeholder="Your story"></textarea>
                <div id="previousStories" class="mb-4 text-sm text-gray-700"></div>
                <div class="flex justify-end space-x-2">
                    <button id="submitStory" class="bg-black text-white px-4 py-2 rounded">Submit</button>
                    <button id="closeModal" class="bg-gray-500 text-white px-4 py-2 rounded">Close</button>
                </div>
            </div>
        </div>

        <footer class="text-center mt-12 text-xs text-gray-600">
            <p>Mendace Veritas</p>
        </footer>
    </div>
    <script src="ledger.js"></script>

<script>
let allLedgerEntries = [];



        function applySubindices(str) {
            return str.replace(/999(?:_|\.)?(\d+)/g, '999<sub>$1</sub>');
        }

        function displayEntries(entriesToDisplay, searchTerm = "") {
            const container = document.getElementById('ledgerEntries');
            container.innerHTML = '';

            if (entriesToDisplay.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">No entries found.</p>';
                return;
            }
            
            const searchRegex = searchTerm ? new RegExp(searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi') : null;

            entriesToDisplay.forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'ledger-entry';

                let idHTML = entry.id + '.';
                let titleHTML = entry.title;
                let descriptionHTML = entry.description || '';

                if (searchTerm && searchRegex) {
                    idHTML = entry.id.replace(searchRegex, match => `<span class="highlight">${match}</span>`) + '.';
                }

                if (searchTerm && searchRegex) {
                    titleHTML = entry.title.replace(searchRegex, match => `<span class="highlight">${match}</span>`);
                    if (entry.description) {
                        descriptionHTML = entry.description.replace(searchRegex, match => `<span class="highlight">${match}</span>`);
                    }
                }

                idHTML = applySubindices(idHTML);
                titleHTML = applySubindices(titleHTML);
                descriptionHTML = applySubindices(descriptionHTML);
                
                const idEl = document.createElement('span');
                idEl.className = 'entry-id';
                idEl.innerHTML = idHTML;

                const titleEl = document.createElement('span');
                titleEl.className = 'entry-title clickable';
                titleEl.innerHTML = titleHTML;
                titleEl.addEventListener('click', () => openSubmissionModal(entry.id, entry.title));
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'flex items-baseline';
                headerDiv.appendChild(idEl);
                headerDiv.appendChild(titleEl);
                entryDiv.appendChild(headerDiv);

                if (entry.description) {
                    const descriptionEl = document.createElement('p');
                    descriptionEl.className = 'entry-description';
                    descriptionEl.innerHTML = descriptionHTML;
                    entryDiv.appendChild(descriptionEl);
                }
                container.appendChild(entryDiv);
            });
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.innerText = str;
            return div.innerHTML;
        }

        function loadStories() {
            try {
                return JSON.parse(localStorage.getItem('ledgerStories') || '{}');
            } catch (e) {
                return {};
            }
        }

        function saveStories(stories) {
            localStorage.setItem('ledgerStories', JSON.stringify(stories));
        }

        const GITHUB_CONFIG = {
            owner: 'LegendaryLad', // Replace with your GitHub username
            repo: 'LegendaryLad.github.io', // Repository name
            path: 'SearchLedger/ledger-submissions.json', // File to store submissions
            branch: 'main', // Branch to update
            token: '' // Personal access token
        };

        async function uploadSubmission(entryId, text, timestamp) {
            const { owner, repo, path, branch, token } = GITHUB_CONFIG;
            const headers = {
                'Accept': 'application/vnd.github+json'
            };
            if (token) headers['Authorization'] = `token ${token}`;

            const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`;
            let submissions = {};
            let sha = undefined;
            try {
                const getRes = await fetch(apiUrl, { headers });
                if (getRes.ok) {
                    const data = await getRes.json();
                    sha = data.sha;
                    submissions = JSON.parse(atob(data.content));
                }
            } catch (e) {
                // ignore fetch errors and start with empty submissions
            }

            if (!submissions[entryId]) submissions[entryId] = [];
            submissions[entryId].push({ text, timestamp });

            const body = {
                message: `Add submission for ${entryId}`,
                content: btoa(JSON.stringify(submissions, null, 2)),
                sha,
                branch
            };

            try {
                await fetch(apiUrl, {
                    method: 'PUT',
                    headers,
                    body: JSON.stringify(body)
                });
            } catch (e) {
                console.error('Failed to upload submission', e);
            }
        }


        function openSubmissionModal(entryId, entryTitle) {
            const modal = document.getElementById('submissionModal');
            modal.dataset.entryId = entryId;
            modal.dataset.entryTitle = entryTitle;
            const formattedId = applySubindices(entryId + '.');
            const formattedTitle = applySubindices(escapeHtml(entryTitle));
            document.getElementById('modalTitle').innerHTML = `${formattedId} ${formattedTitle}`;

            const stories = loadStories();
            const entryStories = stories[entryId] || [];
            const prev = document.getElementById('previousStories');
            prev.innerHTML = entryStories.map(s => `<p>- ${escapeHtml(s)}</p>`).join('');

            document.getElementById('storyInput').value = '';
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeSubmissionModal() {
            const modal = document.getElementById('submissionModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        document.addEventListener('DOMContentLoaded', () => {
            allLedgerEntries = ledgerEntries.slice();
            displayEntries(allLedgerEntries);

            document.getElementById('closeModal').addEventListener('click', closeSubmissionModal);
            document.getElementById('submitStory').addEventListener('click', () => {
                const modal = document.getElementById('submissionModal');
                const entryId = modal.dataset.entryId;
                const entryTitle = modal.dataset.entryTitle;
                const text = document.getElementById('storyInput').value.trim();
                if (!text) return;

                const stories = loadStories();
                if (!stories[entryId]) stories[entryId] = [];
                stories[entryId].push(text);
                saveStories(stories);

                const date = new Date();
                const mm = String(date.getMonth() + 1).padStart(2, '0');
                const dd = String(date.getDate()).padStart(2, '0');
                const yyyy = date.getFullYear();
                const timestamp = `${mm}/${dd}/${yyyy}`;
                uploadSubmission(entryId, text, timestamp);

                openSubmissionModal(entryId, entryTitle);
            });

            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                if (!searchTerm) {
                    displayEntries(allLedgerEntries);
                    return;
                }
                const filteredEntries = allLedgerEntries.filter(entry => {
                    return (entry.id && entry.id.toLowerCase().includes(searchTerm)) ||
                           (entry.title && entry.title.toLowerCase().includes(searchTerm)) ||
                           (entry.description && entry.description.toLowerCase().includes(searchTerm));
                });
                displayEntries(filteredEntries, searchTerm);
            });
        });

    </script>
</body>
</html>
